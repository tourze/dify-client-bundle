# 发送消息

> 发送请求给文本生成型应用。

## OpenAPI

````yaml zh-hans/openapi_completion.json post /completion-messages
paths:
  path: /completion-messages
  method: post
  servers:
    - url: '{api_base_url}'
      description: API 的基础 URL。请将 {api_base_url} 替换为您的应用提供的实际 API 基础 URL。
      variables:
        api_base_url:
          type: string
          description: 实际的 API 基础 URL
          default: https://api.dify.ai/v1
  request:
    security:
      - title: ApiKeyAuth
        parameters:
          query: {}
          header:
            Authorization:
              type: http
              scheme: bearer
              description: >-
                API-Key 鉴权。所有 API 请求都应在 `Authorization` HTTP Header 中包含您的
                API-Key，格式为 `Bearer {API_KEY}`。**强烈建议开发者把 API-Key
                放在后端存储，而非分享或者放在客户端存储，以免 API-Key 泄露，导致财产损失。**
          cookie: {}
    parameters:
      path: {}
      query: {}
      header: {}
      cookie: {}
    body:
      application/json:
        schemaArray:
          - type: object
            properties:
              inputs:
                allOf:
                  - type: object
                    description: >-
                      （选填）允许传入 App 定义的各变量值。inputs
                      参数包含了多组键值对，每组的键对应一个特定变量，值则是该变量的具体值。文本生成型应用要求至少传入一组键值对。
                    required:
                      - query
                    properties:
                      query:
                        type: string
                        description: 用户输入的文本内容。
                    additionalProperties: true
              response_mode:
                allOf:
                  - type: string
                    enum:
                      - streaming
                      - blocking
                    description: >-
                      响应返回模式。`streaming`：流式模式（推荐），基于 SSE
                      实现打字机输出。`blocking`：阻塞模式，等待执行完毕后返回（长流程可能中断）。Cloudflare 限制为
                      100 秒超时。
              user:
                allOf:
                  - type: string
                    description: 用户标识，用于定义终端用户的身份，方便检索、统计。由开发者定义规则，需保证用户标识在应用内唯一。
              files:
                allOf:
                  - type: array
                    items:
                      $ref: '#/components/schemas/InputFileObject'
                    description: 上传的文件列表（目前仅支持图片）。
            required: true
            refIdentifier: '#/components/schemas/CompletionRequest'
            requiredProperties:
              - inputs
              - response_mode
              - user
        examples:
          streaming_example:
            summary: 流式模式示例
            value:
              inputs:
                query: 你好，世界！
              response_mode: streaming
              user: abc-123
        description: 创建完成消息的请求体。
  response:
    '200':
      application/json:
        schemaArray:
          - type: object
            properties:
              message_id:
                allOf:
                  - type: string
                    format: uuid
                    description: 消息唯一 ID。
              mode:
                allOf:
                  - type: string
                    description: App 模式，固定为 `chat`。
                    example: chat
              answer:
                allOf:
                  - type: string
                    description: 完整回复内容。
              metadata:
                allOf:
                  - $ref: '#/components/schemas/ResponseMetadata'
              created_at:
                allOf:
                  - type: integer
                    format: int64
                    description: 消息创建时间戳，如：1705395332。
            description: 阻塞模式下的完整 App 结果。
            refIdentifier: '#/components/schemas/ChatCompletionResponse'
        examples:
          blockingResponse:
            summary: 阻塞模式响应示例
            value:
              id: 0b089b9a-24d9-48cc-94f8-762677276261
              message_id: 0b089b9a-24d9-48cc-94f8-762677276261
              mode: chat
              answer: how are you?
              metadata: {}
              created_at: 1679586667
        description: >-
          成功响应。内容类型和结构取决于请求中的 `response_mode` 参数。

          - 若 `response_mode` 为 `blocking`，返回 `application/json` 及
          `ChatCompletionResponse` 对象。

          - 若 `response_mode` 为 `streaming`，返回 `text/event-stream` 及
          `ChunkChatCompletionResponse` 流式序列。
      text/event-stream:
        schemaArray:
          - type: string
            description: >-
              服务器发送事件 (SSE) 流。每个事件都是以 'data: ' 开头，以 '\n\n' 结尾的 JSON 对象。详见
              `ChunkEvent` 的可能结构。
        examples:
          streamingResponse:
            summary: 流式模式响应示例
            value: >+
              data: {"event": "message", "task_id":
              "900bbd43-dc0b-4383-a372-aa6e6c414227", "id":
              "663c5084-a254-4040-8ad3-51f2a3c1a77c", "message_id":
              "663c5084-a254-4040-8ad3-51f2a3c1a77c", "answer": "Hi",
              "created_at": 1705398420}


              data: {"event": "tts_message", "task_id":
              "3bf8a0bb-e73b-4690-9e66-4e429bad8ee7", "message_id":
              "a8bdc41c-13b2-4c18-bfd9-054b9803038c", "audio":
              "base64encodedaudio...", "created_at": 1721205487}

        description: >-
          成功响应。内容类型和结构取决于请求中的 `response_mode` 参数。

          - 若 `response_mode` 为 `blocking`，返回 `application/json` 及
          `ChatCompletionResponse` 对象。

          - 若 `response_mode` 为 `streaming`，返回 `text/event-stream` 及
          `ChunkChatCompletionResponse` 流式序列。
    '400':
      application/json:
        schemaArray:
          - type: object
            properties:
              status:
                allOf:
                  - &ref_0
                    type: integer
                    description: HTTP 状态码。
                    nullable: true
              code:
                allOf:
                  - &ref_1
                    type: string
                    description: 错误码。
                    nullable: true
              message:
                allOf:
                  - &ref_2
                    type: string
                    description: 错误消息。
            description: 错误响应结构。
            refIdentifier: '#/components/schemas/ErrorResponse'
        examples:
          example:
            value:
              status: 123
              code: <string>
              message: <string>
        description: >-
          错误的请求。可能原因：`invalid_param`（参数异常），`app_unavailable`（App
          配置不可用），`provider_not_initialize`（无可用模型凭据），`provider_quota_exceeded`（额度不足），`model_currently_not_support`（模型不可用），`completion_request_error`（文本生成失败）。
    '404':
      application/json:
        schemaArray:
          - type: object
            properties:
              status:
                allOf:
                  - *ref_0
              code:
                allOf:
                  - *ref_1
              message:
                allOf:
                  - *ref_2
            description: 错误响应结构。
            refIdentifier: '#/components/schemas/ErrorResponse'
        examples:
          example:
            value:
              status: 123
              code: <string>
              message: <string>
        description: 对话不存在。
    '500':
      application/json:
        schemaArray:
          - type: object
            properties:
              status:
                allOf:
                  - *ref_0
              code:
                allOf:
                  - *ref_1
              message:
                allOf:
                  - *ref_2
            description: 错误响应结构。
            refIdentifier: '#/components/schemas/ErrorResponse'
        examples:
          example:
            value:
              status: 123
              code: <string>
              message: <string>
        description: 服务内部异常。
  deprecated: false
  type: path
components:
  schemas:
    InputFileObject:
      type: object
      required:
        - type
        - transfer_method
      properties:
        type:
          type: string
          enum:
            - image
          description: 支持类型：图片 `image`。
        transfer_method:
          type: string
          enum:
            - remote_url
            - local_file
          description: 传递方式，remote_url 用于图片 URL / local_file 用于文件上传
        url:
          type: string
          format: url
          description: 图片地址（当传递方式为 remote_url 时）
        upload_file_id:
          type: string
          description: 上传文件 ID，必须通过事先上传文件接口获得（当传递方式为 local_file 时）
      anyOf:
        - properties:
            transfer_method:
              enum:
                - remote_url
            url:
              type: string
              format: url
          required:
            - url
          not:
            required:
              - upload_file_id
        - properties:
            transfer_method:
              enum:
                - local_file
            upload_file_id:
              type: string
          required:
            - upload_file_id
          not:
            required:
              - url
    ResponseMetadata:
      type: object
      description: 元数据。
      properties:
        usage:
          $ref: '#/components/schemas/Usage'
        retriever_resources:
          type: array
          items:
            $ref: '#/components/schemas/RetrieverResource'
          description: 引用和归属分段列表。
    Usage:
      type: object
      description: 模型用量信息。
      properties:
        prompt_tokens:
          type: integer
        prompt_unit_price:
          type: string
        prompt_price_unit:
          type: string
        prompt_price:
          type: string
        completion_tokens:
          type: integer
        completion_unit_price:
          type: string
        completion_price_unit:
          type: string
        completion_price:
          type: string
        total_tokens:
          type: integer
        total_price:
          type: string
        currency:
          type: string
        latency:
          type: number
          format: double
    RetrieverResource:
      type: object
      description: 引用和归属分段信息。
      properties:
        position:
          type: integer
        dataset_id:
          type: string
          format: uuid
        dataset_name:
          type: string
        document_id:
          type: string
          format: uuid
        document_name:
          type: string
        segment_id:
          type: string
          format: uuid
        score:
          type: number
          format: float
        content:
          type: string

````